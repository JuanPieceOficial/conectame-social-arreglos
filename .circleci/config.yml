version: 2.1
orbs:
  node: circleci/node@5.0.0

jobs:
  build_android:
    docker:
      - image: cimg/android:2024.01
    environment:
      # Corrected ANDROID_HOME path based on CircleCI build logs
      ANDROID_HOME: /home/circleci/android-sdk
    steps:
      - checkout
      - node/install:
          node-version: '20.9.0' # Upgrade to Node.js 20.x for Array.prototype.toReversed() compatibility
      - run:
          name: Display Java Version, ANDROID_HOME and PATH
          command: |
            java -version
            echo "JAVA_HOME is $JAVA_HOME"
            echo "ANDROID_HOME is $ANDROID_HOME"
            echo "PATH is $PATH"
            npm -v
            node -v
      - run:
          name: Clean npm cache and install dependencies
          command: |
            cd mobile/ConectameApp
            npm cache clean --force
            rm -rf node_modules package-lock.json
            npm install
      - run:
          name: Install Ninja Build
          command: |
            sudo apt-get update
            sudo apt-get install -y ninja-build
      - run:
          name: Clean Gradle caches and project
          command: |
            rm -rf ~/.gradle
            cd mobile/ConectameApp/android
            rm -rf ./.gradle
            ./gradlew clean
      - run:
          name: Grant execute permission to gradlew
          command: chmod +x mobile/ConectameApp/android/gradlew
      - run:
          name: Build Android Release AAB
          no_output_timeout: 30m # Increase timeout for potentially long native builds
          command: cd mobile/ConectameApp/android && ./gradlew bundleRelease
      - store_artifacts:
          path: mobile/ConectameApp/android/app/build/outputs/bundle/release/app-release.aab
          destination: app-release.aab
workflows:
  version: 2
  build_and_deploy:
    jobs:
      - build_android
